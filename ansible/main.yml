---
# Main Ansible Playbook for React Chatbot Deployment
# Usage: 
#   ansible-playbook ansible/main.yml
#   ansible-playbook ansible/main.yml --tags build
#   ansible-playbook ansible/main.yml --tags deploy

- name: React Chatbot - Complete Deployment
  hosts: local
  gather_facts: yes
  vars:
    docker_image: "react-chatbot:latest"
    azure_registry: "shanumathew.azurecr.io"
    aws_registry: "317009750119.dkr.ecr.ap-south-1.amazonaws.com"
    project_path: "C:\\Users\\shanu.Nustartz\\Desktop\\chatbot devops"

  tasks:
    - name: Print welcome message
      debug:
        msg:
          - "╔═══════════════════════════════════════════════════╗"
          - "║  React Chatbot - Ansible Deployment Automation   ║"
          - "╚═══════════════════════════════════════════════════╝"
      tags: always

    - name: Build Docker image
      block:
        - name: Navigate to project and build
          shell: |
            cd "{{ project_path }}"
            docker build -t {{ docker_image }} .
          register: build_output

        - name: Show build output
          debug:
            msg: "{{ build_output.stdout_lines[-5:] }}"
      tags: build

    - name: Tag images
      block:
        - name: Tag for Azure
          shell: docker tag {{ docker_image }} {{ azure_registry }}/react-chatbot:latest
          register: tag_azure

        - name: Tag for AWS
          shell: docker tag {{ docker_image }} {{ aws_registry }}/chatbot:latest
          register: tag_aws

        - name: Show tagged images
          shell: docker images | grep react-chatbot
          register: images

        - debug:
            msg: "{{ images.stdout_lines }}"
      tags:
        - build
        - tag

    - name: Push to registries
      block:
        - name: Push to Azure Container Registry
          shell: docker push {{ azure_registry }}/react-chatbot:latest
          register: push_azure
          ignore_errors: yes

        - name: Show Azure push result
          debug:
            msg: "✅ Pushed to Azure: {{ azure_registry }}/react-chatbot:latest"
          when: push_azure.rc == 0

        - name: Show Azure push error
          debug:
            msg: "⚠️ Azure push error: {{ push_azure.stderr }}"
          when: push_azure.rc != 0
      tags:
        - build
        - push

    - name: Show deployment summary
      debug:
        msg:
          - "✅ Deployment Summary:"
          - ""
          - "📦 Docker Image:"
          - "  Local: {{ docker_image }}"
          - "  Azure: {{ azure_registry }}/react-chatbot:latest"
          - "  AWS: {{ aws_registry }}/chatbot:latest"
          - ""
          - "🚀 Next Steps:"
          - "  1. Create Azure Container Instance"
          - "  2. Or deploy to AWS AppRunner"
          - ""
          - "📊 View Logs:"
          - "  ansible-playbook ansible/azure-container-manage.yml"
      tags: always
